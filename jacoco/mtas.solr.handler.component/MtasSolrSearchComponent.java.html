<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MtasSolrSearchComponent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MTAS</a> &gt; <a href="index.source.html" class="el_package">mtas.solr.handler.component</a> &gt; <span class="el_source">MtasSolrSearchComponent.java</span></div><h1>MtasSolrSearchComponent.java</h1><pre class="source lang-java linenums">package mtas.solr.handler.component;

import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.Map;
import java.util.Objects;
import java.util.Map.Entry;

import mtas.codec.util.CodecComponent.ComponentDocument;
import mtas.codec.util.CodecComponent.ComponentFacet;
import mtas.codec.util.CodecComponent.ComponentFields;
import mtas.codec.util.CodecComponent.ComponentGroup;
import mtas.codec.util.CodecComponent.ComponentCollection;
import mtas.codec.util.CodecComponent.ComponentKwic;
import mtas.codec.util.CodecComponent.ComponentList;
import mtas.codec.util.CodecComponent.ComponentPosition;
import mtas.codec.util.CodecComponent.ComponentSpan;
import mtas.codec.util.CodecComponent.ComponentTermVector;
import mtas.codec.util.CodecComponent.ComponentToken;
import mtas.codec.util.CodecUtil;
import mtas.codec.util.Status;
import mtas.solr.handler.component.util.MtasSolrResultMerge;
import mtas.solr.handler.util.MtasSolrStatus;
import mtas.solr.handler.util.MtasSolrStatus.ShardStatus;
import mtas.solr.search.MtasSolrCollectionCache;
import mtas.solr.handler.component.util.MtasSolrComponentDocument;
import mtas.solr.handler.component.util.MtasSolrComponentFacet;
import mtas.solr.handler.component.util.MtasSolrComponentGroup;
import mtas.solr.handler.MtasRequestHandler;
import mtas.solr.handler.MtasRequestHandler.ShardInformation;
import mtas.solr.handler.component.util.MtasSolrComponentCollection;
import mtas.solr.handler.component.util.MtasSolrComponentKwic;
import mtas.solr.handler.component.util.MtasSolrComponentList;
import mtas.solr.handler.component.util.MtasSolrComponentPrefix;
import mtas.solr.handler.component.util.MtasSolrComponentStats;
import mtas.solr.handler.component.util.MtasSolrComponentStatus;
import mtas.solr.handler.component.util.MtasSolrComponentTermvector;
import mtas.solr.handler.component.util.MtasSolrComponentVersion;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.lucene.index.ExitableDirectoryReader;
import org.apache.solr.common.params.CommonParams;
import org.apache.solr.common.params.ShardParams;
import org.apache.solr.common.util.NamedList;
import org.apache.solr.common.util.SimpleOrderedMap;
import org.apache.solr.core.SolrInfoBean;
import org.apache.solr.handler.component.ResponseBuilder;
import org.apache.solr.handler.component.SearchComponent;
import org.apache.solr.handler.component.ShardRequest;
import org.apache.solr.search.DocList;
import org.apache.solr.search.DocSet;
import org.apache.solr.search.SolrIndexSearcher;

/**
 * The Class MtasSolrSearchComponent.
 */
<span class="fc" id="L61">public class MtasSolrSearchComponent extends SearchComponent {</span>

	/** The log. */
<span class="fc" id="L64">	private static Log log = LogFactory.getLog(MtasSolrSearchComponent.class);</span>

	/** The search component. */
	MtasSolrSearchComponent searchComponent;

	/** The Constant CONFIG_COLLECTION_CACHE_DIRECTORY. */
	public static final String CONFIG_COLLECTION_CACHE_DIRECTORY = &quot;collectionCacheDirectory&quot;;

	/** The Constant CONFIG_COLLECTION_LIFETIME. */
	public static final String CONFIG_COLLECTION_LIFETIME = &quot;collectionLifetime&quot;;

	/** The Constant CONFIG_COLLECTION_MAXIMUM_NUMBER. */
	public static final String CONFIG_COLLECTION_MAXIMUM_NUMBER = &quot;collectionMaximumNumber&quot;;

	/** The Constant CONFIG_COLLECTION_MAXIMUM_OVERFLOW. */
	public static final String CONFIG_COLLECTION_MAXIMUM_OVERFLOW = &quot;collectionMaximumOverflow&quot;;

	/** The Constant NAME. */
	public static final String NAME = &quot;mtas&quot;;

	/** The Constant PARAM_MTAS. */
	public static final String PARAM_MTAS = &quot;mtas&quot;;

	/** The Constant STAGE_TERMVECTOR_MISSING_TOP. */
<span class="fc" id="L88">	public static final int STAGE_TERMVECTOR_MISSING_TOP = ResponseBuilder.STAGE_EXECUTE_QUERY + 10;</span>

	/** The Constant STAGE_TERMVECTOR_MISSING_KEY. */
<span class="fc" id="L91">	public static final int STAGE_TERMVECTOR_MISSING_KEY = ResponseBuilder.STAGE_EXECUTE_QUERY + 11;</span>

	/** The Constant STAGE_TERMVECTOR_FINISH. */
<span class="fc" id="L94">	public static final int STAGE_TERMVECTOR_FINISH = ResponseBuilder.STAGE_EXECUTE_QUERY + 12;</span>

	/** The Constant STAGE_LIST. */
<span class="fc" id="L97">	public static final int STAGE_LIST = ResponseBuilder.STAGE_EXECUTE_QUERY + 20;</span>

	/** The Constant STAGE_PREFIX. */
<span class="fc" id="L100">	public static final int STAGE_PREFIX = ResponseBuilder.STAGE_EXECUTE_QUERY + 30;</span>

	/** The Constant STAGE_STATS. */
<span class="fc" id="L103">	public static final int STAGE_STATS = ResponseBuilder.STAGE_EXECUTE_QUERY + 40;</span>

	/** The Constant STAGE_FACET. */
<span class="fc" id="L106">	public static final int STAGE_FACET = ResponseBuilder.STAGE_EXECUTE_QUERY + 50;</span>

	/** The Constant STAGE_GROUP. */
<span class="fc" id="L109">	public static final int STAGE_GROUP = ResponseBuilder.STAGE_EXECUTE_QUERY + 60;</span>

	/** The Constant STAGE_COLLECTION_INIT. */
<span class="fc" id="L112">	public static final int STAGE_COLLECTION_INIT = ResponseBuilder.STAGE_EXECUTE_QUERY + 70;</span>

	/** The Constant STAGE_COLLECTION_FINISH. */
<span class="fc" id="L115">	public static final int STAGE_COLLECTION_FINISH = ResponseBuilder.STAGE_EXECUTE_QUERY + 71;</span>

	/** The Constant STAGE_DOCUMENT. */
<span class="fc" id="L118">	public static final int STAGE_DOCUMENT = ResponseBuilder.STAGE_GET_FIELDS + 10;</span>

	/** The mtas solr result merge. */
	private MtasSolrResultMerge mtasSolrResultMerge;

	/** The search stats. */
	private MtasSolrComponentStats searchStats;

	/** The search termvector. */
	private MtasSolrComponentTermvector searchTermvector;

	/** The search prefix. */
	private MtasSolrComponentPrefix searchPrefix;

	/** The search facet. */
	private MtasSolrComponentFacet searchFacet;

	/** The search group. */
	private MtasSolrComponentGroup searchGroup;

	/** The search list. */
	private MtasSolrComponentList searchList;

	/** The search kwic. */
	private MtasSolrComponentKwic searchKwic;

	/** The search document. */
	private MtasSolrComponentDocument searchDocument;

	/** The search collection. */
	private MtasSolrComponentCollection searchCollection;

	/** The search status. */
	private MtasSolrComponentStatus searchStatus;

	private MtasSolrComponentVersion searchVersion;

	/** The collection cache. */
<span class="fc" id="L156">	private MtasSolrCollectionCache collectionCache = null;</span>

	/** The request handler. */
<span class="fc" id="L159">	private MtasRequestHandler requestHandler = null;</span>

	/** The request handler name. */
<span class="fc" id="L162">	private String requestHandlerName = null;</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see org.apache.solr.handler.component.SearchComponent#init(org.apache.solr.
	 * common.util.NamedList)
	 */
	@Override
	public void init(NamedList args) {
<span class="fc" id="L172">		super.init(args);</span>
		// init components
<span class="fc" id="L174">		searchStatus = new MtasSolrComponentStatus(this);</span>
<span class="fc" id="L175">		searchVersion = new MtasSolrComponentVersion(this);</span>
<span class="fc" id="L176">		searchDocument = new MtasSolrComponentDocument(this);</span>
<span class="fc" id="L177">		searchKwic = new MtasSolrComponentKwic(this);</span>
<span class="fc" id="L178">		searchList = new MtasSolrComponentList(this);</span>
<span class="fc" id="L179">		searchGroup = new MtasSolrComponentGroup(this);</span>
<span class="fc" id="L180">		searchTermvector = new MtasSolrComponentTermvector(this);</span>
<span class="fc" id="L181">		searchPrefix = new MtasSolrComponentPrefix(this);</span>
<span class="fc" id="L182">		searchStats = new MtasSolrComponentStats(this);</span>
<span class="fc" id="L183">		searchFacet = new MtasSolrComponentFacet(this);</span>
<span class="fc" id="L184">		searchCollection = new MtasSolrComponentCollection(this);</span>
		// init collection
<span class="fc" id="L186">		String collectionCacheDirectory = null;</span>
<span class="fc" id="L187">		Long collectionLifetime = null;</span>
<span class="fc" id="L188">		Integer collectionMaximumNumber = null;</span>
<span class="fc" id="L189">		Integer collectionMaximumOverflow = null;</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">		if (args.get(CONFIG_COLLECTION_CACHE_DIRECTORY) != null</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">				&amp;&amp; args.get(CONFIG_COLLECTION_CACHE_DIRECTORY) instanceof String) {</span>
<span class="fc" id="L192">			collectionCacheDirectory = (String) args.get(CONFIG_COLLECTION_CACHE_DIRECTORY);</span>
		} else {
<span class="nc" id="L194">			log.error(&quot;no &quot; + CONFIG_COLLECTION_CACHE_DIRECTORY + &quot; defined for &quot; + this.getClass().getSimpleName());</span>
		}
<span class="pc bpc" id="L196" title="2 of 4 branches missed.">		if (args.get(CONFIG_COLLECTION_LIFETIME) != null &amp;&amp; args.get(CONFIG_COLLECTION_LIFETIME) instanceof Long) {</span>
<span class="fc" id="L197">			collectionLifetime = (Long) args.get(CONFIG_COLLECTION_LIFETIME);</span>
		} else {
<span class="nc" id="L199">			log.error(&quot;no &quot; + CONFIG_COLLECTION_LIFETIME + &quot; defined for &quot; + this.getClass().getSimpleName());</span>
		}
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">		if (args.get(CONFIG_COLLECTION_MAXIMUM_NUMBER) != null</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">				&amp;&amp; args.get(CONFIG_COLLECTION_MAXIMUM_NUMBER) instanceof Integer) {</span>
<span class="fc" id="L203">			collectionMaximumNumber = (Integer) args.get(CONFIG_COLLECTION_MAXIMUM_NUMBER);</span>
		} else {
<span class="nc" id="L205">			log.error(&quot;no &quot; + CONFIG_COLLECTION_MAXIMUM_NUMBER + &quot; defined for &quot; + this.getClass().getSimpleName());</span>
		}
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">		if (args.get(CONFIG_COLLECTION_MAXIMUM_OVERFLOW) != null</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">				&amp;&amp; args.get(CONFIG_COLLECTION_MAXIMUM_OVERFLOW) instanceof Integer) {</span>
<span class="fc" id="L209">			collectionMaximumNumber = (Integer) args.get(CONFIG_COLLECTION_MAXIMUM_OVERFLOW);</span>
		} else {
<span class="nc" id="L211">			log.error(&quot;no &quot; + CONFIG_COLLECTION_MAXIMUM_OVERFLOW + &quot; defined for &quot; + this.getClass().getSimpleName());</span>
		}
<span class="fc" id="L213">		collectionCache = new MtasSolrCollectionCache(collectionCacheDirectory, collectionLifetime,</span>
				collectionMaximumNumber, collectionMaximumOverflow);
<span class="fc" id="L215">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see org.apache.solr.handler.component.SearchComponent#getDescription()
	 */
	@Override
	public String getDescription() {
<span class="nc" id="L224">		return &quot;Mtas&quot;;</span>
	}

	/**
	 * Gets the collection cache.
	 *
	 * @return the collection cache
	 */
	public MtasSolrCollectionCache getCollectionCache() {
<span class="fc" id="L233">		return collectionCache;</span>
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#prepare(org.apache.solr.
	 * handler.component.ResponseBuilder)
	 */
	@Override
	public void prepare(ResponseBuilder rb) throws IOException {
		// System.out
		// .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		// + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		// + &quot; PREPARE &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
		// always create status
<span class="fc" id="L250">		initializeRequestHandler(rb);</span>
<span class="fc" id="L251">		MtasSolrStatus solrStatus = new MtasSolrStatus(rb.req.getOriginalParams().toQueryString(),</span>
<span class="fc" id="L252">				rb.req.getParams().getBool(ShardParams.IS_SHARD, false), rb.shards, rb.rsp);</span>
<span class="fc" id="L253">		rb.req.getContext().put(MtasSolrStatus.class, solrStatus);</span>
<span class="fc" id="L254">		solrStatus.setStage(rb.stage);</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">		if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
			try {
				// initialize
<span class="fc" id="L258">				mtasSolrResultMerge = new MtasSolrResultMerge();</span>
				// prepare components
<span class="fc" id="L260">				ComponentFields mtasFields = new ComponentFields();</span>
				// get settings version
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentVersion.PARAM_MTAS_VERSION, false)) {</span>
<span class="nc" id="L263">					searchVersion.prepare(rb, mtasFields);</span>
				}
				// get settings status
<span class="fc bfc" id="L266" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentStatus.PARAM_MTAS_STATUS, false)) {</span>
<span class="fc" id="L267">					searchStatus.prepare(rb, mtasFields);</span>
<span class="fc" id="L268">					mtasFields.status.handler = requestHandlerName;</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">					if (mtasFields.status.key != null) {</span>
<span class="fc" id="L270">						solrStatus.setKey(mtasFields.status.key);</span>
					}
				}
				// now, register status
<span class="fc" id="L274">				registerStatus(solrStatus);</span>
				// get settings document
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L277">					searchDocument.prepare(rb, mtasFields);</span>
				}
				// get settings kwic
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentKwic.PARAM_MTAS_KWIC, false)) {</span>
<span class="nc" id="L281">					searchKwic.prepare(rb, mtasFields);</span>
				}
				// get settings list
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L285">					searchList.prepare(rb, mtasFields);</span>
				}
				// get settings group
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="nc" id="L289">					searchGroup.prepare(rb, mtasFields);</span>
				}
				// get settings termvector
<span class="fc bfc" id="L292" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L293">					searchTermvector.prepare(rb, mtasFields);</span>
				}
				// get settings prefix
<span class="fc bfc" id="L296" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX, false)) {</span>
<span class="fc" id="L297">					searchPrefix.prepare(rb, mtasFields);</span>
				}
				// get settings stats
<span class="fc bfc" id="L300" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L301">					searchStats.prepare(rb, mtasFields);</span>
				}
				// get settings facet
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L305">					searchFacet.prepare(rb, mtasFields);</span>
				}
				// get settings collection
<span class="fc bfc" id="L308" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L309">					searchCollection.prepare(rb, mtasFields);</span>
				}
<span class="fc" id="L311">				rb.req.getContext().put(ComponentFields.class, mtasFields);</span>
<span class="nc" id="L312">			} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L313">				solrStatus.setError(e.getMessage());</span>
<span class="nc" id="L314">			} catch (IOException e) {</span>
<span class="nc" id="L315">				solrStatus.setError(e);</span>
			} finally {
<span class="pc" id="L317">				checkStatus(solrStatus);</span>
<span class="pc" id="L318">			}</span>
		} else {
			// register and check status
<span class="fc" id="L321">			registerStatus(solrStatus);</span>
<span class="fc" id="L322">			checkStatus(solrStatus);</span>
		}
<span class="fc" id="L324">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#process(org.apache.solr.
	 * handler.component.ResponseBuilder)
	 */
	@Override
	public void process(ResponseBuilder rb) throws IOException {
		// System.out
		// .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		// + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		// + &quot; PROCESS &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L339">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L340">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L341">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L343" title="All 2 branches covered.">			if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
				try {
<span class="fc" id="L345">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">					if (mtasFields != null) {</span>
<span class="fc" id="L347">						DocSet docSet = rb.getResults().docSet;</span>
<span class="fc" id="L348">						DocList docList = rb.getResults().docList;</span>
<span class="pc bpc" id="L349" title="8 of 22 branches missed.">						if (mtasFields.doStats || mtasFields.doDocument || mtasFields.doKwic || mtasFields.doList</span>
								|| mtasFields.doGroup || mtasFields.doFacet || mtasFields.doCollection
								|| mtasFields.doTermVector || mtasFields.doPrefix || mtasFields.doStatus
								|| mtasFields.doVersion) {
<span class="fc" id="L353">							SolrIndexSearcher searcher = rb.req.getSearcher();</span>
<span class="fc" id="L354">							ArrayList&lt;Integer&gt; docSetList = null;</span>
<span class="fc" id="L355">							ArrayList&lt;Integer&gt; docListList = null;</span>
							// initialise docSetList
<span class="fc bfc" id="L357" title="All 2 branches covered.">							if (docSet != null) {</span>
<span class="fc" id="L358">								docSetList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L359">								Iterator&lt;Integer&gt; docSetIterator = docSet.iterator();</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">								while (docSetIterator.hasNext()) {</span>
<span class="fc" id="L361">									docSetList.add(docSetIterator.next());</span>
								}
<span class="fc" id="L363">								Collections.sort(docSetList);</span>
							}
							// initialise docListList
<span class="pc bpc" id="L366" title="1 of 2 branches missed.">							if (docList != null) {</span>
<span class="fc" id="L367">								docListList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L368">								Iterator&lt;Integer&gt; docListIterator = docList.iterator();</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">								while (docListIterator.hasNext()) {</span>
<span class="fc" id="L370">									docListList.add(docListIterator.next());</span>
								}
<span class="fc" id="L372">								Collections.sort(docListList);</span>
							}
<span class="fc" id="L374">							solrStatus.status().addSubs(mtasFields.list.keySet());</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">							for (String field : mtasFields.list.keySet()) {</span>
								try {
<span class="fc" id="L377">									CodecUtil.collectField(field, searcher, searcher.getRawReader(), docListList,</span>
<span class="fc" id="L378">											docSetList, mtasFields.list.get(field), solrStatus.status());</span>
<span class="nc" id="L379">								} catch (IllegalAccessException | IllegalArgumentException</span>
										| InvocationTargetException e) {
<span class="nc" id="L381">									log.error(e);</span>
<span class="nc" id="L382">									throw new IOException(e);</span>
<span class="fc" id="L383">								}</span>
<span class="fc" id="L384">							}</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">							for (ComponentCollection collection : mtasFields.collection) {</span>
<span class="fc" id="L386">								CodecUtil.collectCollection(searcher.getRawReader(), docSetList, collection);</span>
<span class="fc" id="L387">							}</span>
<span class="fc" id="L388">							NamedList&lt;Object&gt; mtasResponse = new SimpleOrderedMap&lt;&gt;();</span>
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">							if (mtasFields.doVersion) {</span>
<span class="nc" id="L390">								SimpleOrderedMap&lt;Object&gt; versionResponse = searchVersion.create(mtasFields.version,</span>
<span class="nc" id="L391">										false);</span>
<span class="nc" id="L392">								mtasResponse.add(MtasSolrComponentVersion.NAME, versionResponse);</span>
							}
<span class="fc bfc" id="L394" title="All 2 branches covered.">							if (mtasFields.doStatus) {</span>
								// add to response
<span class="fc" id="L396">								SimpleOrderedMap&lt;Object&gt; statusResponse = searchStatus.create(mtasFields.status, false);</span>
<span class="fc bfc" id="L397" title="All 2 branches covered.">								if (statusResponse != null) {</span>
<span class="fc" id="L398">									mtasResponse.add(MtasSolrComponentStatus.NAME,</span>
<span class="fc" id="L399">											searchStatus.create(mtasFields.status, false));</span>
								}
							}
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">							if (mtasFields.doDocument) {</span>
<span class="nc" id="L403">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasDocumentResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">									for (ComponentDocument document : mtasFields.list.get(field).documentList) {</span>
<span class="nc" id="L406">										mtasDocumentResponses.add(searchDocument.create(document, false));</span>
<span class="nc" id="L407">									}</span>
<span class="nc" id="L408">								}</span>
								// add to response
<span class="nc" id="L410">								mtasResponse.add(MtasSolrComponentDocument.NAME, mtasDocumentResponses);</span>
							}
<span class="pc bpc" id="L412" title="1 of 2 branches missed.">							if (mtasFields.doKwic) {</span>
<span class="nc" id="L413">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasKwicResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">									for (ComponentKwic kwic : mtasFields.list.get(field).kwicList) {</span>
<span class="nc" id="L416">										mtasKwicResponses.add(searchKwic.create(kwic, false));</span>
<span class="nc" id="L417">									}</span>
<span class="nc" id="L418">								}</span>
								// add to response
<span class="nc" id="L420">								mtasResponse.add(MtasSolrComponentKwic.NAME, mtasKwicResponses);</span>
							}
<span class="pc bpc" id="L422" title="1 of 2 branches missed.">							if (mtasFields.doFacet) {</span>
<span class="nc" id="L423">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasFacetResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">									for (ComponentFacet facet : mtasFields.list.get(field).facetList) {</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">										if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="nc" id="L427">											mtasFacetResponses.add(searchFacet.create(facet, true));</span>
										} else {
<span class="nc" id="L429">											mtasFacetResponses.add(searchFacet.create(facet, false));</span>
										}
<span class="nc" id="L431">									}</span>
<span class="nc" id="L432">								}</span>
								// add to response
<span class="nc" id="L434">								mtasResponse.add(MtasSolrComponentFacet.NAME, mtasFacetResponses);</span>
							}
<span class="fc bfc" id="L436" title="All 2 branches covered.">							if (mtasFields.doCollection) {</span>
<span class="fc" id="L437">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasCollectionResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">								for (ComponentCollection collection : mtasFields.collection) {</span>
<span class="fc bfc" id="L439" title="All 2 branches covered.">									if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L440">										mtasCollectionResponses.add(searchCollection.create(collection, true));</span>
									} else {
<span class="fc" id="L442">										mtasCollectionResponses.add(searchCollection.create(collection, false));</span>
									}
<span class="fc" id="L444">								}</span>
								// add to response
<span class="fc" id="L446">								mtasResponse.add(MtasSolrComponentCollection.NAME, mtasCollectionResponses);</span>
							}
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">							if (mtasFields.doList) {</span>
<span class="nc" id="L449">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasListResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">									for (ComponentList list : mtasFields.list.get(field).listList) {</span>
<span class="nc" id="L452">										mtasListResponses.add(searchList.create(list, false));</span>
<span class="nc" id="L453">									}</span>
<span class="nc" id="L454">								}</span>
								// add to response
<span class="nc" id="L456">								mtasResponse.add(MtasSolrComponentList.NAME, mtasListResponses);</span>
							}
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">							if (mtasFields.doGroup) {</span>
<span class="nc" id="L459">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasGroupResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">									for (ComponentGroup group : mtasFields.list.get(field).groupList) {</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">										if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="nc" id="L463">											mtasGroupResponses.add(searchGroup.create(group, true));</span>
										} else {
<span class="nc" id="L465">											mtasGroupResponses.add(searchGroup.create(group, false));</span>
										}
<span class="nc" id="L467">									}</span>
<span class="nc" id="L468">								}</span>
								// add to response
<span class="nc" id="L470">								mtasResponse.add(MtasSolrComponentGroup.NAME, mtasGroupResponses);</span>
							}
<span class="fc bfc" id="L472" title="All 2 branches covered.">							if (mtasFields.doTermVector) {</span>
<span class="fc" id="L473">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasTermVectorResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L474" title="All 2 branches covered.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L475" title="All 2 branches covered.">									for (ComponentTermVector termVector : mtasFields.list.get(field).termVectorList) {</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">										if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L477">											mtasTermVectorResponses.add(searchTermvector.create(termVector, true));</span>
										} else {
<span class="fc" id="L479">											mtasTermVectorResponses.add(searchTermvector.create(termVector, false));</span>
										}
<span class="fc" id="L481">									}</span>
<span class="fc" id="L482">								}</span>
								// add to response
<span class="fc" id="L484">								mtasResponse.add(MtasSolrComponentTermvector.NAME, mtasTermVectorResponses);</span>
							}
<span class="fc bfc" id="L486" title="All 2 branches covered.">							if (mtasFields.doPrefix) {</span>
<span class="fc" id="L487">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasPrefixResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L488" title="All 2 branches covered.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">									if (mtasFields.list.get(field).prefix != null) {</span>
<span class="fc bfc" id="L490" title="All 2 branches covered.">										if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L491">											mtasPrefixResponses</span>
<span class="fc" id="L492">													.add(searchPrefix.create(mtasFields.list.get(field).prefix, true));</span>
										} else {
<span class="fc" id="L494">											mtasPrefixResponses</span>
<span class="fc" id="L495">													.add(searchPrefix.create(mtasFields.list.get(field).prefix, false));</span>
										}
									}
<span class="fc" id="L498">								}</span>
<span class="fc" id="L499">								mtasResponse.add(MtasSolrComponentPrefix.NAME, mtasPrefixResponses);</span>
							}
<span class="fc bfc" id="L501" title="All 2 branches covered.">							if (mtasFields.doStats) {</span>
<span class="fc" id="L502">								NamedList&lt;Object&gt; mtasStatsResponse = new SimpleOrderedMap&lt;&gt;();</span>
<span class="pc bpc" id="L503" title="1 of 6 branches missed.">								if (mtasFields.doStatsPositions || mtasFields.doStatsTokens</span>
										|| mtasFields.doStatsSpans) {
<span class="fc bfc" id="L505" title="All 2 branches covered.">									if (mtasFields.doStatsTokens) {</span>
<span class="fc" id="L506">										ArrayList&lt;Object&gt; mtasStatsTokensResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L507" title="All 2 branches covered.">										for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">											for (ComponentToken token : mtasFields.list.get(field).statsTokenList) {</span>
<span class="fc bfc" id="L509" title="All 2 branches covered.">												if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L510">													mtasStatsTokensResponses.add(searchStats.create(token, true));</span>
												} else {
<span class="fc" id="L512">													mtasStatsTokensResponses.add(searchStats.create(token, false));</span>
												}
<span class="fc" id="L514">											}</span>
<span class="fc" id="L515">										}</span>
<span class="fc" id="L516">										mtasStatsResponse.add(MtasSolrComponentStats.NAME_TOKENS,</span>
												mtasStatsTokensResponses);
									}
<span class="fc bfc" id="L519" title="All 2 branches covered.">									if (mtasFields.doStatsPositions) {</span>
<span class="fc" id="L520">										ArrayList&lt;Object&gt; mtasStatsPositionsResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L521" title="All 2 branches covered.">										for (String field : mtasFields.list.keySet()) {</span>
											for (ComponentPosition position : mtasFields.list
<span class="fc bfc" id="L523" title="All 2 branches covered.">													.get(field).statsPositionList) {</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">												if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L525">													mtasStatsPositionsResponses.add(searchStats.create(position, true));</span>
												} else {
<span class="fc" id="L527">													mtasStatsPositionsResponses</span>
<span class="fc" id="L528">															.add(searchStats.create(position, false));</span>
												}
<span class="fc" id="L530">											}</span>
<span class="fc" id="L531">										}</span>
<span class="fc" id="L532">										mtasStatsResponse.add(MtasSolrComponentStats.NAME_POSITIONS,</span>
												mtasStatsPositionsResponses);
									}
<span class="fc bfc" id="L535" title="All 2 branches covered.">									if (mtasFields.doStatsSpans) {</span>
<span class="fc" id="L536">										ArrayList&lt;Object&gt; mtasStatsSpansResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L537" title="All 2 branches covered.">										for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L538" title="All 2 branches covered.">											for (ComponentSpan span : mtasFields.list.get(field).statsSpanList) {</span>
<span class="fc bfc" id="L539" title="All 2 branches covered.">												if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L540">													mtasStatsSpansResponses.add(searchStats.create(span, true));</span>
												} else {
<span class="fc" id="L542">													mtasStatsSpansResponses.add(searchStats.create(span, false));</span>
												}
<span class="fc" id="L544">											}</span>
<span class="fc" id="L545">										}</span>
<span class="fc" id="L546">										mtasStatsResponse.add(MtasSolrComponentStats.NAME_SPANS,</span>
												mtasStatsSpansResponses);
									}
									// add to response
<span class="fc" id="L550">									mtasResponse.add(MtasSolrComponentStats.NAME, mtasStatsResponse);</span>
								}
							}
							// add to response
<span class="fc bfc" id="L554" title="All 2 branches covered.">							if (mtasResponse.size() &gt; 0) {</span>
<span class="fc" id="L555">								rb.rsp.add(NAME, mtasResponse);</span>
							}
						}
					}
<span class="nc" id="L559">				} catch (IOException e) {</span>
<span class="nc" id="L560">					errorStatus(solrStatus, e);</span>
<span class="fc" id="L561">				}</span>
			}
<span class="pc bpc" id="L563" title="1 of 2 branches missed.">			if (!solrStatus.error()) {</span>
				// always set status segments
<span class="fc bfc" id="L565" title="All 2 branches covered.">				if (solrStatus.status().numberSegmentsTotal == null) {</span>
<span class="fc" id="L566">					solrStatus.status().numberSegmentsTotal = rb.req.getSearcher().getRawReader().leaves().size();</span>
<span class="fc" id="L567">					solrStatus.status().numberSegmentsFinished = solrStatus.status().numberSegmentsTotal;</span>
				}
				// always try to set number of documents
<span class="fc bfc" id="L570" title="All 2 branches covered.">				if (solrStatus.status().numberDocumentsTotal == null) {</span>
					SolrIndexSearcher searcher;
<span class="pc bpc" id="L572" title="1 of 2 branches missed.">					if ((searcher = rb.req.getSearcher()) != null) {</span>
<span class="fc" id="L573">						solrStatus.status().numberDocumentsTotal = (long) searcher.numDocs();</span>
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">						if (rb.getResults().docList != null) {</span>
<span class="fc" id="L575">							solrStatus.status().numberDocumentsFinished = rb.getResults().docList.matches();</span>
<span class="fc" id="L576">							solrStatus.status().numberDocumentsFound = rb.getResults().docList.matches();</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">						} else if (rb.getResults().docSet != null) {</span>
<span class="nc" id="L578">							solrStatus.status().numberDocumentsFinished = (long) rb.getResults().docSet.size();</span>
<span class="nc" id="L579">							solrStatus.status().numberDocumentsFound = (long) rb.getResults().docSet.size();</span>
						}
					}
				}
			}
<span class="nc" id="L584">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L585">			solrStatus.setError(e.getMessage());</span>
		} finally {
<span class="pc" id="L587">			checkStatus(solrStatus);</span>
<span class="pc" id="L588">			finishStatus(solrStatus);</span>
<span class="pc" id="L589">		}</span>
<span class="fc" id="L590">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#modifyRequest(org.apache.
	 * solr.handler.component.ResponseBuilder,
	 * org.apache.solr.handler.component.SearchComponent,
	 * org.apache.solr.handler.component.ShardRequest)
	 */
	@Override
	public void modifyRequest(ResponseBuilder rb, SearchComponent who, ShardRequest sreq) {
		 // System.out
		 // .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		 // + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		 // + &quot; MODIFY REQUEST &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L607">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L608">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L609">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L611" title="All 2 branches covered.">			if (sreq.params.getBool(PARAM_MTAS, false)) {</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentStatus.PARAM_MTAS_STATUS, false)) {</span>
<span class="nc" id="L613">					searchStatus.modifyRequest(rb, who, sreq);</span>
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">				} else if (requestHandler != null) {</span>
<span class="fc" id="L615">					sreq.params.add(MtasSolrComponentStatus.PARAM_MTAS_STATUS, CommonParams.TRUE);</span>
				}
<span class="pc bpc" id="L617" title="1 of 2 branches missed.">				if (requestHandler != null) {</span>
<span class="fc" id="L618">					sreq.params.add(MtasSolrComponentStatus.PARAM_MTAS_STATUS + &quot;.&quot;</span>
<span class="fc" id="L619">							+ MtasSolrComponentStatus.NAME_MTAS_STATUS_KEY, solrStatus.shardKey(rb.stage));</span>
				}
<span class="pc bpc" id="L621" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentVersion.PARAM_MTAS_VERSION, false)) {</span>
<span class="nc" id="L622">					searchVersion.modifyRequest(rb, who, sreq);</span>
				}
<span class="fc bfc" id="L624" title="All 2 branches covered.">				if (sreq.params.getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L625">					searchStats.modifyRequest(rb, who, sreq);</span>
				}
<span class="fc bfc" id="L627" title="All 2 branches covered.">				if (sreq.params.getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L628">					searchTermvector.modifyRequest(rb, who, sreq);</span>
				}
<span class="fc bfc" id="L630" title="All 2 branches covered.">				if (sreq.params.getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX, false)) {</span>
<span class="fc" id="L631">					searchPrefix.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L633" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L634">					searchFacet.modifyRequest(rb, who, sreq);</span>
				}
<span class="fc bfc" id="L636" title="All 2 branches covered.">				if (sreq.params.getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L637">					searchCollection.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L639" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="nc" id="L640">					searchGroup.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L642" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L643">					searchList.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L645" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L646">					searchDocument.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentKwic.PARAM_MTAS_KWIC, false)) {</span>
<span class="nc" id="L649">					searchKwic.modifyRequest(rb, who, sreq);</span>
				}
			}
<span class="nc" id="L652">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L653">			solrStatus.setError(e.getMessage());</span>
<span class="fc" id="L654">		}</span>
<span class="fc" id="L655">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see org.apache.solr.handler.component.SearchComponent#handleResponses(org.
	 * apache.solr.handler.component.ResponseBuilder,
	 * org.apache.solr.handler.component.ShardRequest)
	 */
	@Override
	public void handleResponses(ResponseBuilder rb, ShardRequest sreq) {
		 // System.out
		 // .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		 // + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		 // + &quot; HANDLERESPONSES &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L670">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L671">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L672">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L674" title="All 2 branches covered.">			if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>

				// do nothing
			}
<span class="nc" id="L678">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L679">			solrStatus.setError(e.getMessage());</span>
<span class="fc" id="L680">		}</span>
<span class="fc" id="L681">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#distributedProcess(org.
	 * apache.solr.handler.component.ResponseBuilder)
	 */
	@Override
	public void finishStage(ResponseBuilder rb) {
		 // System.out
		 // .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		 //  + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		 // + &quot; FINISHRESPONSES &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L696">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L697">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L698">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L700" title="All 2 branches covered.">			if (rb.stage == ResponseBuilder.STAGE_EXECUTE_QUERY) {</span>
<span class="fc" id="L701">				Status status = solrStatus.status();</span>
<span class="pc bpc" id="L702" title="1 of 2 branches missed.">				if (status.numberDocumentsFound == null) {</span>
<span class="fc" id="L703">					status.numberDocumentsFound = rb.getNumberDocumentsFound();</span>
				}
				// try to finish status from get fields stage
<span class="fc bfc" id="L706" title="All 2 branches covered.">			} else if (rb.stage &gt;= ResponseBuilder.STAGE_GET_FIELDS) {</span>
<span class="fc" id="L707">				finishStatus(solrStatus);</span>
			}
<span class="fc bfc" id="L709" title="All 2 branches covered.">			if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentVersion.PARAM_MTAS_VERSION, false)) {</span>
<span class="nc" id="L711">					searchVersion.finishStage(rb);</span>
				}
<span class="fc bfc" id="L713" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L714">					searchStats.finishStage(rb);</span>
				}
<span class="fc bfc" id="L716" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L717">					searchTermvector.finishStage(rb);</span>
				}
<span class="fc bfc" id="L719" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX, false)) {</span>
<span class="fc" id="L720">					searchPrefix.finishStage(rb);</span>
				}
<span class="pc bpc" id="L722" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L723">					searchFacet.finishStage(rb);</span>
				}
<span class="fc bfc" id="L725" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L726">					searchCollection.finishStage(rb);</span>
				}
<span class="pc bpc" id="L728" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="nc" id="L729">					searchGroup.finishStage(rb);</span>
				}
<span class="pc bpc" id="L731" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L732">					searchList.finishStage(rb);</span>
				}
<span class="pc bpc" id="L734" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L735">					searchDocument.finishStage(rb);</span>
				}
<span class="pc bpc" id="L737" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentKwic.PARAM_MTAS_KWIC, false)) {</span>
<span class="nc" id="L738">					searchKwic.finishStage(rb);</span>
				}
<span class="fc" id="L740">				mtasSolrResultMerge.merge(rb);</span>
			}
<span class="nc" id="L742">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L743">			solrStatus.setError(e.getMessage());</span>
<span class="fc" id="L744">		}</span>
<span class="fc" id="L745">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#distributedProcess(org.
	 * apache.solr.handler.component.ResponseBuilder)
	 */
	@Override
	public int distributedProcess(ResponseBuilder rb) throws IOException {
		 // System.out.println(System.nanoTime() + &quot; - &quot;
		 // + Thread.currentThread().getId() + &quot; - &quot;
		 // + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		 // + &quot; DISTIRBUTEDPROCESS &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L760">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L761">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L762">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L764" title="All 2 branches covered.">			if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
<span class="fc bfc" id="L765" title="All 6 branches covered.">				if (rb.stage == STAGE_TERMVECTOR_MISSING_TOP || rb.stage == STAGE_TERMVECTOR_MISSING_KEY</span>
						|| rb.stage == STAGE_TERMVECTOR_FINISH) {
<span class="fc" id="L767">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L768">					searchTermvector.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L769" title="1 of 2 branches missed.">				} else if (rb.stage == STAGE_LIST) {</span>
<span class="nc" id="L770">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L771">					searchList.distributedProcess(rb, mtasFields);</span>
<span class="pc bfc" id="L772" title="All 2 branches covered.">				} else if (rb.stage == STAGE_PREFIX) {</span>
<span class="fc" id="L773">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L774">					searchPrefix.distributedProcess(rb, mtasFields);</span>
<span class="fc bfc" id="L775" title="All 2 branches covered.">				} else if (rb.stage == STAGE_STATS) {</span>
<span class="fc" id="L776">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L777">					searchStats.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L778" title="1 of 2 branches missed.">				} else if (rb.stage == STAGE_FACET) {</span>
<span class="nc" id="L779">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L780">					searchFacet.distributedProcess(rb, mtasFields);</span>
<span class="pc bfc" id="L781" title="All 4 branches covered.">				} else if (rb.stage == STAGE_COLLECTION_INIT || rb.stage == STAGE_COLLECTION_FINISH) {</span>
<span class="fc" id="L782">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L783">					searchCollection.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L784" title="1 of 2 branches missed.">				} else if (rb.stage == STAGE_GROUP) {</span>
<span class="nc" id="L785">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L786">					searchGroup.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L787" title="1 of 2 branches missed.">				} else if (rb.stage == STAGE_DOCUMENT) {</span>
<span class="nc" id="L788">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L789">					searchDocument.distributedProcess(rb, mtasFields);</span>
				}
				// compute new stage and return if not finished
<span class="fc bfc" id="L792" title="All 4 branches covered.">				if (rb.stage &gt;= ResponseBuilder.STAGE_EXECUTE_QUERY &amp;&amp; rb.stage &lt; ResponseBuilder.STAGE_GET_FIELDS) {</span>
<span class="fc bfc" id="L793" title="All 2 branches covered.">					if (rb.stage &lt; STAGE_TERMVECTOR_MISSING_TOP</span>
<span class="fc bfc" id="L794" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L795">						return STAGE_TERMVECTOR_MISSING_TOP;</span>
<span class="fc bfc" id="L796" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_TERMVECTOR_MISSING_KEY</span>
<span class="fc bfc" id="L797" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L798">						return STAGE_TERMVECTOR_MISSING_KEY;</span>
<span class="fc bfc" id="L799" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_TERMVECTOR_FINISH</span>
<span class="fc bfc" id="L800" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L801">						return STAGE_TERMVECTOR_FINISH;</span>
<span class="fc bfc" id="L802" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_LIST</span>
<span class="pc bpc" id="L803" title="1 of 2 branches missed.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L804">						return STAGE_LIST;</span>
<span class="fc bfc" id="L805" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_PREFIX</span>
<span class="fc bfc" id="L806" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX, false)) {</span>
<span class="fc" id="L807">						return STAGE_PREFIX;</span>
<span class="fc bfc" id="L808" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_STATS</span>
<span class="fc bfc" id="L809" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L810">						return STAGE_STATS;</span>
<span class="fc bfc" id="L811" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_FACET</span>
<span class="pc bpc" id="L812" title="1 of 2 branches missed.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L813">						return STAGE_FACET;</span>
<span class="fc bfc" id="L814" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_GROUP</span>
<span class="pc bpc" id="L815" title="1 of 2 branches missed.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="nc" id="L816">						return STAGE_GROUP;</span>
<span class="fc bfc" id="L817" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_COLLECTION_INIT</span>
<span class="fc bfc" id="L818" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L819">						return STAGE_COLLECTION_INIT;</span>
<span class="fc bfc" id="L820" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_COLLECTION_FINISH</span>
<span class="fc bfc" id="L821" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L822">						return STAGE_COLLECTION_FINISH;</span>
					}
<span class="pc bpc" id="L824" title="1 of 4 branches missed.">				} else if (rb.stage &gt;= ResponseBuilder.STAGE_GET_FIELDS &amp;&amp; rb.stage &lt; ResponseBuilder.STAGE_DONE) {</span>
<span class="pc bpc" id="L825" title="1 of 2 branches missed.">					if (rb.stage &lt; STAGE_DOCUMENT</span>
<span class="pc bpc" id="L826" title="1 of 2 branches missed.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L827">						return STAGE_DOCUMENT;</span>
					}
				}
			}
<span class="nc" id="L831">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L832">			solrStatus.setError(e.getMessage());</span>
<span class="nc" id="L833">			finishStatus(solrStatus);</span>
		} finally {
<span class="pc" id="L835">		  checkStatus(solrStatus);</span>
<span class="pc" id="L836">		}</span>
<span class="fc" id="L837">		return ResponseBuilder.STAGE_DONE;</span>
	}

	/**
	 * Gets the mtas fields.
	 *
	 * @param rb
	 *            the rb
	 * @return the mtas fields
	 */

	private ComponentFields getMtasFields(ResponseBuilder rb) {
<span class="fc" id="L849">		return (ComponentFields) rb.req.getContext().get(ComponentFields.class);</span>
	}

	/**
	 * Initialize request handler.
	 *
	 * @param rb
	 *            the rb
	 */
	private void initializeRequestHandler(ResponseBuilder rb) {
<span class="fc bfc" id="L859" title="All 2 branches covered.">		if (requestHandler == null) {</span>
			// try to initialize
<span class="pc bpc" id="L861" title="1 of 2 branches missed.">			for (Entry&lt;String, SolrInfoBean&gt; entry : rb.req.getCore().getInfoRegistry().entrySet()) {</span>
<span class="pc bpc" id="L862" title="1 of 2 branches missed.">				if (entry.getValue() instanceof MtasRequestHandler) {</span>
<span class="fc" id="L863">					requestHandlerName = entry.getKey();</span>
<span class="fc" id="L864">					requestHandler = (MtasRequestHandler) entry.getValue();</span>
<span class="fc" id="L865">					break;</span>
				}
<span class="nc" id="L867">			}</span>
		}
<span class="fc" id="L869">	}</span>

	/**
	 * Check status.
	 *
	 * @param status
	 *            the status
	 * @throws IOException
	 *             Signals that an I/O exception has occurred.
	 */
	private void checkStatus(MtasSolrStatus status) throws IOException {
<span class="pc bpc" id="L880" title="1 of 2 branches missed.">		if (!status.finished()) {</span>
<span class="pc bpc" id="L881" title="1 of 2 branches missed.">			if (status.error()) {</span>
<span class="nc" id="L882">				status.setFinished();</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">				if (requestHandler != null) {</span>
<span class="nc" id="L884">					requestHandler.finishStatus(status);</span>
				}
<span class="nc" id="L886">				throw new IOException(status.errorMessage());</span>
<span class="pc bpc" id="L887" title="1 of 2 branches missed.">			} else if (status.abort()) {</span>
<span class="nc" id="L888">				status.setFinished();</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">				if (requestHandler != null) {</span>
<span class="nc" id="L890">					requestHandler.finishStatus(status);</span>
				}
<span class="nc" id="L892">				throw new IOException(status.abortMessage());</span>
			}
		}
<span class="fc" id="L895">	}</span>

	/**
	 * Register status.
	 *
	 * @param solrStatus
	 *            the solr status
	 * @throws IOException
	 *             Signals that an I/O exception has occurred.
	 */
	private void registerStatus(MtasSolrStatus solrStatus) throws IOException {
<span class="pc bpc" id="L906" title="1 of 2 branches missed.">		if (requestHandler != null) {</span>
<span class="fc" id="L907">			Map&lt;String, ShardStatus&gt; shards = solrStatus.getShards();</span>
<span class="fc bfc" id="L908" title="All 2 branches covered.">			if (shards != null) {</span>
<span class="fc" id="L909">				Status status = solrStatus.status();</span>
<span class="fc" id="L910">				status.numberDocumentsTotal = Long.valueOf(0);</span>
<span class="fc" id="L911">				status.numberSegmentsTotal = 0;</span>
<span class="fc bfc" id="L912" title="All 2 branches covered.">				for (Entry&lt;String, ShardStatus&gt; entry : shards.entrySet()) {</span>
					// get shard info
<span class="fc" id="L914">					ShardInformation shardInformation = requestHandler.getShardInformation(entry.getKey());</span>
<span class="pc bpc" id="L915" title="1 of 2 branches missed.">					if (shardInformation == null) {</span>
<span class="nc" id="L916">						throw new IOException(&quot;no shard information &quot; + entry.getKey());</span>
					}
<span class="fc" id="L918">					ShardStatus shardStatus = entry.getValue();</span>
<span class="fc" id="L919">					shardStatus.name = shardInformation.name;</span>
<span class="fc" id="L920">					shardStatus.location = entry.getKey();</span>
<span class="fc" id="L921">					shardStatus.mtasHandler = shardInformation.mtasHandler;</span>
<span class="fc" id="L922">					shardStatus.numberDocumentsTotal = shardInformation.numberOfDocuments;</span>
<span class="fc" id="L923">					shardStatus.numberSegmentsTotal = shardInformation.numberOfSegments;</span>
<span class="fc" id="L924">					status.numberDocumentsTotal += shardInformation.numberOfDocuments;</span>
<span class="fc" id="L925">					status.numberSegmentsTotal += shardInformation.numberOfSegments;</span>
<span class="fc" id="L926">				}</span>
			}
<span class="fc" id="L928">			requestHandler.registerStatus(solrStatus);</span>
		}
<span class="fc" id="L930">	}</span>

	/**
	 * Error status.
	 *
	 * @param status
	 *            the status
	 * @param exception
	 *            the exception
	 */
	private void errorStatus(MtasSolrStatus status, IOException exception) {
		try {
<span class="nc" id="L942">			status.setError(exception);</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">			if (requestHandler != null) {</span>
<span class="nc" id="L944">				requestHandler.finishStatus(status);</span>
			}
<span class="nc" id="L946">		} catch (IOException e) {</span>
<span class="nc" id="L947">			log.error(e);</span>
<span class="nc" id="L948">		}</span>
<span class="nc" id="L949">	}</span>

	/**
	 * Finish status.
	 *
	 * @param status
	 *            the status
	 */
	private void finishStatus(MtasSolrStatus status) {
<span class="pc bpc" id="L958" title="1 of 2 branches missed.">		if (!status.finished()) {</span>
<span class="fc" id="L959">			status.setFinished();</span>
<span class="pc bpc" id="L960" title="1 of 2 branches missed.">			if (requestHandler != null) {</span>
				try {
<span class="fc" id="L962">					requestHandler.finishStatus(status);</span>
<span class="nc" id="L963">				} catch (IOException e) {</span>
<span class="nc" id="L964">					log.error(e);</span>
<span class="fc" id="L965">				}</span>
			}
		}
<span class="fc" id="L968">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>